# Generated by Django 3.1.12 on 2021-09-15 11:17

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('addresses', '0001_initial'),
        ('customers', '0014_fetch_customers_by_not_activity_sql_procedure'),
    ]

    operations = [
        migrations.AddField(
            model_name='customer',
            name='address',
            field=models.ForeignKey(blank=True, default=None, null=True, on_delete=models.deletion.SET_NULL,
                                    to='addresses.addressmodel'),
        ),
        migrations.RunSQL(
            # Attach customers to address streets
            sql=(
                "UPDATE customers "
                "SET address_id = ("
                    "SELECT adrs.id "
                        "FROM customers c "
                            "LEFT JOIN customer_street cs ON cs.id = c.street_id "
                             "LEFT JOIN addresses adrs ON ("
                                 "adrs.parent_addr_id = cs.group_id "
                                 "AND adrs.title = cs.name"
                             ") "
                            "WHERE c.baseaccount_ptr_id = customers.baseaccount_ptr_id"
                    ")"
            )
        ),
        migrations.RemoveField(
            model_name='customer',
            name='street'
        )
    ]
